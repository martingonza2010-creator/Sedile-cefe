<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="favicon.jpg" type="image/jpeg">
    <title>SEDILE HRA | Professional Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="style.css">
    <link rel="manifest" href="manifest.json">
</head>

<body>
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>

    <!-- PANTALLA DE ACCESO (LOGIN) -->
    <section id="auth-screen" class="auth-container">
        <div class="login-card">
            <img src="https://i.imgur.com/ugEhxa1.jpeg" alt="Logo NutriMartin" class="logo-entrance">
            <h1>Bienvenido a SEDILE - HRA</h1>
            <p>Portal de Apoyo Nutricional Cl√≠nico</p>
            <button id="btnLoginGoogle" class="btn-google" onclick="window.login()">
                <img src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" alt="G">
                Entrar con Google
            </button>
            <small>Creado por Nutricionista Martin E. Gonzalez</small>
        </div>
    </section>

    <!-- APLICACI√ìN PRINCIPAL (OCULTA HASTA LOGIN) -->
    <div id="main-app" class="app-container compact-mode" style="display:none;">

        <!-- Info Protocol Button -->
        <button class="protocol-fab" id="btnProtocolOpen" title="Protocolos Institucionales">
            <span>i</span> Protocolos HRA
        </button>

        <!-- Bot√≥n Logout -->
        <button class="logout-btn" id="btnLogout" title="Cerrar Sesi√≥n">Salir</button>

        <header class="main-header">
            <div class="brand-box">
                <img src="https://i.imgur.com/ugEhxa1.jpeg" alt="Logo" class="logo-small">
                <div>
                    <h1>SEDILE - HRA</h1>
                    <p id="userNameDisplay">Calculadora Cl√≠nica</p>
                    <p style="font-size: 0.65rem; opacity: 0.6; margin-top: 2px;">Nut. Martin E. Gonzalez</p>
                </div>
            </div>

            <div class="patient-quick-access" id="btnPatientToggle">
                <div class="p-avatar" id="currentPatientAvatar">P</div>
                <div class="p-info">
                    <span id="currentPatientName">Nuevo Paciente</span>
                    <small style="display:flex; align-items:center; gap:5px;">
                        IMC: <b id="valBMI">--</b>
                    </small>
                </div>
            </div>
        </header>

        <main class="dashboard-grid">
            <!-- SECCI√ìN 1: EVALUACI√ìN -->
            <section class="card assessment-card">
                <div class="card-header">
                    <h3>Registro Evaluaci√≥n</h3>
                    <div class="header-actions">
                        <button class="btn-micro" id="btnOpenHistory">üìÇ Historial</button>
                        <button class="btn-micro" id="btnAddPatient">+ Nuevo</button>
                    </div>
                </div>
                <form id="form-paciente" class="compact-form">
                    <div class="input-row">
                        <input type="text" id="nombre" placeholder="Nombre completo" required>
                    </div>
                    <div class="grid-col-4">
                        <div class="mini-input">
                            <label>Edad</label>
                            <input type="number" id="edad" placeholder="0">
                        </div>
                        <div class="mini-input">
                            <label>Sexo</label>
                            <select id="sexo">
                                <option value="m">M</option>
                                <option value="f">F</option>
                            </select>
                        </div>
                        <div class="mini-input">
                            <label>Peso (kg)</label>
                            <input type="number" step="0.1" id="peso" placeholder="0">
                        </div>
                        <div class="mini-input">
                            <label>Talla (m)</label>
                            <input type="number" step="0.01" id="estatura" placeholder="0">
                        </div>
                    </div>
                    <div class="input-row-multi">
                        <select id="actividad" class="select-small">
                            <option value="1.2">AF: 1.2 (Reposo)</option>
                            <option value="1.3">AF: 1.3 (Ligero)</option>
                            <option value="1.5">AF: 1.5 (Mod)</option>
                        </select>
                    </div>

                    <!-- NEW: Goal & Evolution Inputs -->
                    <div style="margin-top: 15px; padding-top:15px; border-top:1px dashed #ddd;">
                        <label
                            style="font-size:0.75rem; font-weight:700; color:#666; margin-bottom:5px; display:block;">Metas
                            y Evoluci√≥n</label>
                        <div class="grid-col-2" style="grid-template-columns: 1fr 1fr; gap:10px; display:grid;">
                            <div class="mini-input">
                                <label>Meta Kcal/kg</label>
                                <input type="number" id="goalKcalBox" placeholder="Ej. 20">
                            </div>
                            <div class="mini-input">
                                <label>Meta Total (Kcal)</label>
                                <input type="number" id="goalTotal" placeholder="Total">
                            </div>
                        </div>
                    </div>

                    <div class="input-row-multi" style="margin-top:15px;">
                        <button type="submit" class="btn-save-small" style="width:100%;">Guardar Paciente</button>
                    </div>
                </form>
            </section>

            <!-- NEW: Hydration Card -->
            <section class="card hydration-card" style="border-left: 5px solid #3498db;">
                <div class="card-header" style="margin-bottom:10px;">
                    <h3>üíß Balance H√≠drico</h3>
                    <div style="display:flex; gap:10px; font-size:0.8rem;">
                        <label style="cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <input type="radio" name="hydMethod" value="holiday" checked onchange="toggleHydMethod()">
                            Holiday
                        </label>
                        <label style="cursor:pointer; display:flex; align-items:center; gap:4px;">
                            <input type="radio" name="hydMethod" value="mlkg" onchange="toggleHydMethod()"> ml/kg
                        </label>
                    </div>
                </div>

                <!-- Input Factor ml/kg (Hidden by default) -->
                <div id="hydFactorRow" style="display:none; margin-bottom:15px; text-align:right;">
                    <label style="font-size:0.8rem; margin-right:5px;">Factor:</label>
                    <input type="number" id="hydFactor" value="30"
                        style="width:50px; padding:4px; border-radius:6px; border:1px solid #ddd; text-align:center;">
                    <span style="font-size:0.8rem;">ml/kg</span>
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <div style="text-align:center;">
                        <span style="font-size:0.7rem; color:#888;">Requerimiento</span>
                        <div style="font-size:1.4rem; font-weight:700; color:#3498db;"><span id="hydReq">0</span> ml
                        </div>
                    </div>
                    <div style="font-size:1.5rem; opacity:0.2;">‚ûî</div>
                    <div style="text-align:center;">
                        <span style="font-size:0.7rem; color:#888;">D√©ficit (Agua Libre)</span>
                        <div style="font-size:1.4rem; font-weight:700; color:#e74c3c;" id="hydDeficitBox"><span
                                id="hydDeficit">0</span> ml</div>
                    </div>
                </div>
                <div class="water-bar-container">
                    <div class="water-bar" id="hydBar"></div>
                </div>
                <small style="text-align:center; display:block; margin-top:5px; opacity:0.6; font-size:0.7rem;">Basado
                    en Peso Actual</small>
            </section>


            <!-- SECCI√ìN 2: SIMULADOR INTEGRADO -->
            <section class="card simulator-card">
                <div class="sim-header-dashboard">
                    <div class="mode-selector">
                        <button class="mode-toggle active" data-mode="vol">Vol / Dil</button>
                        <button class="mode-toggle" data-mode="grams">Gramaje</button>
                    </div>

                    <!-- NEW: Compare Toggle -->
                    <button id="btnToggleCompare" class="btn-micro"
                        style="margin-left:auto; display:flex; align-items:center; gap:5px; border-color:#888; color:#555;">
                        <span>‚öñÔ∏è</span> Comparar
                    </button>

                    <div class="progress-container-mini">
                        <div class="prog-label">Meta: <span id="simGoal">--</span> kcal</div>
                        <div class="prog-track">
                            <div class="prog-fill" id="simBar"></div>
                        </div>
                        <div class="prog-label">Cons: <span id="simCurrent">0</span> kcal</div>
                    </div>
                </div>

                <!-- NEW: Infusion Calculator -->
                <div class="infusion-box">
                    <div class="infusion-title">
                        <span>‚è±Ô∏è Calculadora de Infusi√≥n</span>
                        <small style="opacity:0.5; font-weight:400;">(Opcional)</small>
                    </div>
                    <div class="grid-col-2">
                        <div class="mini-input">
                            <label>Velocidad (ml/hr)</label>
                            <input type="number" id="infusionRate" placeholder="Ej. 60">
                        </div>
                        <div class="mini-input">
                            <label>Hora Inicio</label>
                            <input type="time" id="infusionStart">
                        </div>
                    </div>
                    <div class="infusion-result" id="infusionResultBox" style="display:none;">
                        Termina a las: <strong id="valEndTime">--:--</strong> <span id="valDuration"
                            style="font-size:0.75rem; opacity:0.7;">(0 hrs)</span>
                    </div>
                </div>

                <div class="sim-inputs">
                    <div class="input-group">
                        <label>F√≥rmula / Leche HRA / RTH</label>
                        <div style="display:flex; gap:10px; align-items:center;">
                            <select id="formulaSelect" class="select-modern"></select>
                            <button id="btnToggleFav" class="btn-micro" style="font-size:1.2rem; padding: 5px 10px;"
                                title="Marcar como Favorita">‚òÜ</button>
                        </div>
                    </div>

                    <!-- NEW: Compare Formula Selector (Hidden) -->
                    <div class="input-group" id="compareRow"
                        style="display:none; margin-top:10px; border-top:1px dashed #ddd; padding-top:10px;">
                        <label style="color:var(--secondary); font-weight:700;">üÜö Comparar con:</label>
                        <select id="formulaSelectB" class="select-modern"></select>
                        <div id="compareResult"
                            style="margin-top:5px; font-size:0.8rem; display:flex; gap:10px; justify-content:flex-end;">
                            <!-- JS will populate -->
                        </div>
                    </div>

                    <div class="grid-col-2">
                        <div class="input-group">
                            <label>Volumen (ml)</label>
                            <input type="number" id="volume" placeholder="ml">
                        </div>
                        <div class="input-group">
                            <label id="lblDilution">Diluci√≥n (%)</label>
                            <input type="number" id="dilution" placeholder="%">
                        </div>
                    </div>
                </div>

    </div>
    </div>

    <!-- NEW: Stacked Bar -->
    <div class="macro-stack-bar">
        <div class="stack-segment p" id="barProt" style="width:0%"></div>
        <div class="stack-segment c" id="barCHO" style="width:0%"></div>
        <div class="stack-segment f" id="barLip" style="width:0%"></div>
    </div>

    <div class="macro-board">
        <div class="macro-item k"><label>Energ√≠a</label><span id="valKcal">0</span><small>kcal</small></div>
        <div class="macro-item p"><label>Prot</label><span id="valProt">0</span><small>g</small></div>
        <div class="macro-item c"><label>CHO</label><span id="valCHO">0</span><small>g</small></div>
        <div class="macro-item f"><label>L√≠p</label><span id="valLip">0</span><small>g</small></div>
    </div>

    <button class="btn-primary-wide" id="btnSaveHistory">Prescribir y Guardar Cloud</button>
    <div id="pwaInstallContainer" style="display:none; text-align:center; margin-top:15px;">
        <span id="btnInstallApp"
            style="cursor:pointer; font-size:0.75rem; color:var(--primary); text-decoration:underline;">
            Dejar aplicaci√≥n en pantalla de inicio üì±
        </span>
    </div>
    </section>
    </main>

    <!-- MODAL DE HISTORIAL -->
    <div class="protocol-modal" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Historial de Pacientes</h2>
                <button class="btn-close" id="btnHistoryClose">&times;</button>
            </div>
            <div class="history-list" id="historyContainer">
                <div id="chartContainer"
                    style="display:none; margin-bottom: 20px; padding: 10px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                    <canvas id="evolutionChart" width="400" height="200"></canvas>
                    <p style="text-align:center; font-size:0.7rem; color:#888; margin-top:5px;">Evoluci√≥n de Peso
                        (√öltimos 5 registros)</p>
                </div>
                <p style="text-align:center; opacity:0.6;">Cargando tus registros...</p>
            </div>
        </div>
    </div>

    <!-- MODAL DE PROTOCOLOS (EXISTENTE) -->
    <div class="protocol-modal" id="protocolModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Protocolos Institucionales HRA</h2>
                <button class="btn-close" id="btnProtocolClose">&times;</button>
            </div>
            <div class="tab-nav">
                <button class="tab-btn active" onclick="switchProtocolTab(0)">Velocidades RTH</button>
                <button class="tab-btn" onclick="switchProtocolTab(1)">Horarios de Entrega</button>
            </div>
            <div class="tab-content" id="tab-infusion" style="display:block;">
                <h3 class="table-title">Enterales en ml y su duraci√≥n</h3>
                <div class="table-scroll">
                    <table class="pretty-table">
                        <thead>
                            <tr>
                                <th>500 ml</th>
                                <th>1000 ml</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Row 1 -->
                            <tr>
                                <td>20 ml/h = <strong>24 hrs</strong></td>
                                <td>40 ml/h = <strong>24 hrs</strong></td>
                            </tr>
                            <!-- Row 2 -->
                            <tr>
                                <td>25 ml/h = <strong>20 hrs</strong></td>
                                <td>50 ml/h = <strong>20 hrs</strong></td>
                            </tr>
                            <!-- Row 3 -->
                            <tr>
                                <td>30 ml/h = <strong>16 hrs</strong></td>
                                <td>60 ml/h = <strong>16 hrs</strong></td>
                            </tr>
                            <!-- Row 4 -->
                            <tr>
                                <td>40 ml/h = <strong>12 hrs</strong></td>
                                <td>75 ml/h = <strong>13 hrs</strong></td>
                            </tr>
                            <!-- Row 5 -->
                            <tr>
                                <td>50 ml/h = <strong>10 hrs</strong></td>
                                <td>80 ml/h = <strong>12 hrs</strong></td>
                            </tr>
                            <!-- Row 6 -->
                            <tr>
                                <td>60 ml/h = <strong>8 hrs</strong></td>
                                <td>-</td>
                            </tr>
                            <!-- Row 7 -->
                            <tr>
                                <td>75 ml/h = <strong>6 hrs</strong></td>
                                <td>-</td>
                            </tr>
                            <!-- Row 8 -->
                            <tr>
                                <td>80 ml/h = <strong>6 hrs</strong></td>
                                <td>-</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="tab-content" id="tab-delivery" style="display:none;">
                <div class="table-scroll">
                    <table class="schedule-table">
                        <tr>
                            <td>Q3H</td>
                            <td>03-06-09-12-15-18-21-24</td>
                        </tr>
                        <tr>
                            <td>Q4H</td>
                            <td>06-10-14-18-22-02</td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>
    </div>

    <script src="script.js?v=20260130-0000"></script>
</body>

</html>